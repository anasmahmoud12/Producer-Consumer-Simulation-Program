<div class="simulation-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="main-title">Production Line Simulator</h1>
        <p class="subtitle">Producer/Consumer Queuing Network with Design Patterns</p>
      </div>
      
      <div class="header-actions">
        <!-- Connection Status -->
        <div class="connection-status" [ngClass]="{'connected': connectionStatus.includes('Connected')}">
          <span class="status-dot"></span>
          {{ connectionStatus }}
        </div>
        
        <button class="btn btn-primary" (click)="toggleStats()">
          üìä Statistics
        </button>
        <button class="btn btn-secondary" (click)="toggleSettings()">
          ‚öôÔ∏è Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Control Panel -->
  <div class="control-panel">
    <div class="control-actions">
      <button 
        *ngIf="!isRunning" 
        class="btn btn-success btn-lg"
        (click)="startSimulation()">
        ‚ñ∂Ô∏è Start Simulation
      </button>
      
      <ng-container *ngIf="isRunning">
        <button 
          class="btn btn-danger"
          (click)="stopSimulation()">
          ‚èπÔ∏è Pause
        </button>
      </ng-container>
      
      <button 
        class="btn btn-info"
        (click)="replaySimulation()"
        [disabled]="!statistics">
        üîÑ Replay
      </button>
    </div>

    <div class="configuration-actions">
      <button 
        class="btn btn-secondary"
        (click)="onAddQueue()"
        [disabled]="isRunning || isAddingQueue">
        {{ !isAddingQueue ? '‚ûï Add Queue': 'Select Position' }}
      </button>
      <button 
        class="btn btn-secondary"
        (click)="onAddMachine()"
        [disabled]="isRunning || isAddingMachine">
        {{ !isAddingMachine ? '‚ûï Add Machine': 'Select Position' }}
      </button>
      <button 
        class="btn btn-secondary"
        [ngClass]="{'active': connectionMode}"
        (click)="toggleConnectionMode()"
        [disabled]="isRunning">
        üîó Connect
      </button>
      <button 
        class="btn btn-secondary"
        (click)="saveConfiguration()">
        üíæ Save Config
      </button>
    </div>
  </div>

  <!-- Main Canvas Area -->
  <div class="canvas-container">
    <!-- ‚úÖ UPDATED: Added mousedown, mousemove, mouseup handlers for dragging -->
    <canvas 
      #canvas 
      (click)="onCanvasClick($event)"
      (mousedown)="onCanvasMouseDown($event)"
      (mousemove)="onCanvasMouseMove($event)"
      (mouseup)="onCanvasMouseUp($event)"
      (mouseleave)="onCanvasMouseUp($event)"
      [ngClass]="{'connection-mode': connectionMode, 'dragging': isDragging}"
      [style.cursor]="getCursorStyle()">
    </canvas>
    
    <div 
      *ngIf="connectionMode" 
      class="connection-hint">
      {{ connectionStart ? 'Click destination element' : 'Click source element' }}
    </div>

    <div 
      *ngIf="isDragging" 
      class="drag-hint">
      Dragging {{ draggedElement?.id }}... Release to place
    </div>

    <!-- Legend -->
    <div class="legend">
      <h4>Legend</h4>
      <div class="legend-item">
        <div class="legend-icon start-node"></div>
        <span>START (Product Generator)</span>
      </div>
      <div class="legend-item">
        <div class="legend-icon queue"></div>
        <span>Queue (shows product count)</span>
      </div>
      <div class="legend-item">
        <div class="legend-icon machine idle"></div>
        <span>Machine (idle)</span>
      </div>
      <div class="legend-item">
        <div class="legend-icon machine processing"></div>
        <span>Machine (processing)</span>
      </div>
      <div class="legend-item">
        <div class="legend-icon end-node"></div>
        <span>END (Product Collector)</span>
      </div>
    </div>
  </div>

  <app-statistics-panel
    *ngIf="showStats"
    [statistics]="statistics"
    (close)="showStats = false">
  </app-statistics-panel>

  <app-settings-panel
    *ngIf="showSettings"
    [(simulationSpeed)]="simulationSpeed"
    [(productionRate)]="productionRate"
    [disabled]="isRunning"
    (close)="showSettings = false">
  </app-settings-panel>

  <app-replay-panel
    *ngIf="showReplay"
    (close)="showReplay = false"
    (snapshotRestored)="onSnapshotRestored()">
  </app-replay-panel>
</div>